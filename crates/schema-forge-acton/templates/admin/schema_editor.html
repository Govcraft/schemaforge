{% extends "admin/base.html" %}

{% block title %}{% if editor.is_edit %}Edit {{ editor.schema_name }}{% else %}Create Schema{% endif %} - SchemaForge Admin{% endblock %}

{% block content %}
<div class="breadcrumbs text-sm">
    <ul>
        <li><a href="/admin/">Dashboard</a></li>
        {% if editor.is_edit %}
        <li><a href="/admin/schemas/{{ editor.schema_name }}">{{ editor.schema_name }}</a></li>
        <li>Edit</li>
        {% else %}
        <li>Create Schema</li>
        {% endif %}
    </ul>
</div>
<div class="mb-6">
    <h2>{% if editor.is_edit %}Edit {{ editor.schema_name }}{% else %}Create Schema{% endif %}</h2>
</div>

{% if !errors.is_empty() %}
<div class="alert alert-error mb-5">
    <strong>Please fix the following errors:</strong>
    <ul class="mt-2 ml-5 list-disc">
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="schema-editor-layout">
    <form id="schema-editor-form"
          method="post"
          action="{% if editor.is_edit %}/admin/schemas/{{ editor.schema_name }}{% else %}/admin/schemas{% endif %}"
          hx-post="/admin/schemas/_preview"
          hx-trigger="input changed delay:500ms, change from:select delay:500ms"
          hx-target="#dsl-preview-content"
          hx-swap="innerHTML">
        {% if editor.is_edit %}
        <input type="hidden" name="_method" value="PUT">
        <input type="hidden" name="_existing_schema_name" value="{{ editor.schema_name }}">
        {% endif %}

        <div class="editor-form-panel">
            <div class="card card-border bg-base-200 mb-5">
                <div class="card-body">
                    <fieldset>
                        <legend class="fieldset-legend">Schema Name <span class="text-error">*</span></legend>
                        <input type="text" id="schema_name" name="schema_name" value="{{ editor.schema_name }}"
                               class="input"
                               placeholder="PascalCase (e.g. Contact, BlogPost)"
                               {% if editor.is_edit %}readonly style="opacity: 0.7;"{% endif %}
                               required>
                    </fieldset>
                    <div class="grid grid-cols-2 gap-4">
                        <fieldset>
                            <legend class="fieldset-legend">Version</legend>
                            <input type="number" id="version" name="version" value="{{ editor.version }}"
                                   class="input"
                                   min="1" step="1" placeholder="Optional">
                        </fieldset>
                        <fieldset>
                            <legend class="fieldset-legend">Display Field</legend>
                            <input type="text" id="display_field" name="display_field" value="{{ editor.display_field }}"
                                   class="input"
                                   placeholder="snake_case field name">
                        </fieldset>
                    </div>
                </div>
            </div>

            <div class="card card-border bg-base-200">
                <div class="card-body">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-semibold">Fields</h3>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="addFieldRow()">+ Add Field</button>
                    </div>

                    <div id="field-list">
                        {% for field in editor.fields %}
                        {% include "admin/fragments/field_editor_row.html" %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-5">
                <button type="submit" class="btn btn-primary"
                        hx-post="{% if editor.is_edit %}/admin/schemas/{{ editor.schema_name }}{% else %}/admin/schemas{% endif %}"
                        hx-target="body"
                        hx-push-url="true"
                        hx-swap="innerHTML"
                        hx-trigger="click"
                        hx-include="#schema-editor-form"
                        {% if editor.is_edit %}hx-vals='{"_method": "PUT"}'{% endif %}>
                    {% if editor.is_edit %}Update Schema{% else %}Create Schema{% endif %}
                </button>
                <a href="{% if editor.is_edit %}/admin/schemas/{{ editor.schema_name }}{% else %}/admin/{% endif %}" class="btn btn-ghost">Cancel</a>
            </div>
        </div>
    </form>

    <div class="editor-preview-panel">
        <div class="card card-border bg-base-200 preview-card">
            <div class="card-body">
                <h3 class="text-sm font-semibold uppercase tracking-wide text-base-content/60 mb-3">DSL Preview</h3>
                <div id="dsl-preview-content">
                    <pre class="dsl-preview-code">// Start typing to see preview...</pre>
                </div>
            </div>
        </div>

        {% if editor.is_edit %}
        <div class="card card-border bg-base-200 preview-card mt-4">
            <div class="card-body">
                <h3 class="text-sm font-semibold uppercase tracking-wide text-base-content/60 mb-3">Migration Preview</h3>
                <div id="migration-preview-content">
                    <p class="text-sm text-base-content/60">Make changes to see migration steps...</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
let fieldCounter = {{ editor.fields.len() }};

function addFieldRow() {
    const index = fieldCounter++;
    fetch(`/admin/schemas/_field-row/${index}`)
        .then(r => r.text())
        .then(html => {
            document.getElementById('field-list').insertAdjacentHTML('beforeend', html);
            htmx.process(document.getElementById('field-list'));
        });
}

function removeFieldRow(btn) {
    btn.closest('.field-editor-row').remove();
    // Trigger preview update
    htmx.trigger(document.getElementById('schema-editor-form'), 'input');
}

function moveFieldUp(btn) {
    const row = btn.closest('.field-editor-row');
    const prev = row.previousElementSibling;
    if (prev && prev.classList.contains('field-editor-row')) {
        row.parentNode.insertBefore(row, prev);
        htmx.trigger(document.getElementById('schema-editor-form'), 'input');
    }
}

function moveFieldDown(btn) {
    const row = btn.closest('.field-editor-row');
    const next = row.nextElementSibling;
    if (next && next.classList.contains('field-editor-row')) {
        row.parentNode.insertBefore(next, row);
        htmx.trigger(document.getElementById('schema-editor-form'), 'input');
    }
}

function onTypeChange(select, index) {
    const type = select.value;
    fetch(`/admin/schemas/_type-constraints/${type}?index=${index}`)
        .then(r => r.text())
        .then(html => {
            document.getElementById(`field-${index}-constraints`).innerHTML = html;
        });
}
</script>
{% endblock %}
